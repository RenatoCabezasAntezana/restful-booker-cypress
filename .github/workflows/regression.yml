name: Cypress Apis Regression Tests

on:
  push:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      testPlanKey:
        description: 'ID del Test Plan (ej. SB-10)'
        required: false
        type: string
      projectKey:
        description: 'ID del Proyecto (ej. SB)'
        required: false
        type: string
  repository_dispatch:
    types: [run-cypress-tests]

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1

      # --- PASO DE VALIDACIÃ“N MEJORADO ---
      - name: ðŸ” Debug Xray Context
        run: |
          echo "Evento disparado por: ${{ github.event_name }}"
          echo "--- Valores desde Payload (Web) ---"
          echo "Project (Payload): ${{ github.event.client_payload.projectKey }}"
          echo "Test Plan (Payload): ${{ github.event.client_payload.testPlanKey }}"
          echo "--- Valores desde Inputs (Manual) ---"
          echo "Project (Input): ${{ github.event.inputs.projectKey }}"
          echo "--- VerificaciÃ³n de Secrets ---"
          if [ -z "${{ secrets.XRAY_CLIENT_ID }}" ]; then echo "âŒ XRAY_CLIENT_ID no estÃ¡ configurado"; else echo "âœ… XRAY_CLIENT_ID detectado"; fi
          if [ -z "${{ secrets.PROJECTKEY }}" ]; then echo "âš ï¸ Secret PROJECTKEY no encontrado, usarÃ© SB por defecto"; fi

      - name: Install dependencies
        run: npm i

      - name: Install Cucumber Formatter (Linux)
        run: |
          curl -L https://github.com/cucumber/json-formatter/releases/download/v19.0.0/cucumber-json-formatter-linux-amd64 -o cucumber-json-formatter
          chmod +x cucumber-json-formatter

      - name: Cypress.io
        continue-on-error: true
        uses: cypress-io/github-action@v6.5.0
        with:
          command: npm run cypress:execution-tags
          browser: chrome
          # record: true # Solo actÃ­valo si tienes configurado Cypress Cloud
        env:
          CUCUMBER_JSON_FORMATTER: ./cucumber-json-formatter
                
      - name: Import Results to Xray
        if: always()
        uses: mikepenz/xray-action@v3
        with:
          username: ${{ secrets.XRAY_CLIENT_ID }}
          password: ${{ secrets.XRAY_CLIENT_SECRET }}
          xrayCloud: "true"
          testFormat: 'cucumber'
          testPaths: 'cypress/reports/cucumber-results.json'
          failOnImportError: true
          # PRIORIDAD DE VALORES: 1. Webhook Payload -> 2. Manual Input -> 3. Secrets -> 4. Hardcoded
          projectKey: "${{ github.event.client_payload.projectKey || github.event.inputs.projectKey || secrets.PROJECTKEY || 'SB' }}"
          testPlanKey: "${{ github.event.client_payload.testPlanKey || github.event.inputs.testPlanKey || secrets.TESTPLANKEY }}"
                
      - name: Upload Cypress Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos/**/*.mp4
